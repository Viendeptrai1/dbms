# üéì T√ìM T·∫ÆT ADVANCED FEATURES - B√ÄI CU·ªêI K√å DBMS

## üìä T·ªïng quan d·ª± √°n sau khi b·ªï sung

### **Database Objects - Tr∆∞·ªõc v√† Sau**

| Lo·∫°i | Ban ƒë·∫ßu | Sau khi th√™m | T·ªïng | TƒÉng |
|------|---------|--------------|------|------|
| **Tables** | 10 | 10 | **10** | 0% (Kh√¥ng ƒë·ªïi schema ‚úÖ) |
| **Functions** | 10 | +5 | **15** | +50% |
| **Stored Procedures** | 11 | +4 | **15** | +36% |
| **Triggers** | 5 | +5 | **10** | +100% |
| **Views** | 3 | +4 | **7** | +133% |
| **Indexes** | 10 | 10 | **10** | 0% |

---

## üéØ T√≠nh nƒÉng m·ªõi (18 objects)

### üìä **FUNCTIONS (5) - Ph√¢n t√≠ch & T√≠nh to√°n**

#### 1. `fn_ProductABCClassification` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: Ph√¢n lo·∫°i Pareto (A: 80%, B: 15%, C: 5%)
- **K·ªπ thu·∫≠t**: Window Functions (`SUM OVER`, `PERCENT_RANK`)
- **Use case**: X√°c ƒë·ªãnh s·∫£n ph·∫©m quan tr·ªçng nh·∫•t
- **Demo**:
  ```sql
  SELECT * FROM fn_ProductABCClassification('2024-01-01', '2024-12-31')
  ORDER BY ABCClass, CumulativePercent;
  ```

#### 2. `fn_InventoryTurnoverRate` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: T√≠nh v√≤ng quay t·ªìn kho
- **K·ªπ thu·∫≠t**: Rolling calculations, Window functions
- **Use case**: ƒê√°nh gi√° hi·ªáu qu·∫£ qu·∫£n l√Ω t·ªìn kho
- **Demo**:
  ```sql
  SELECT * FROM fn_InventoryTurnoverRate(1, 3) -- ProductID=1, 3 months
  ```

#### 3. `fn_CalculateReorderPoint` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: T√≠nh ƒëi·ªÉm ƒë·∫∑t h√†ng t·ªëi ∆∞u
- **K·ªπ thu·∫≠t**: Statistical functions (STDEV, AVG), Z-score
- **C√¥ng th·ª©c**: `ReorderPoint = AvgDailyUsage √ó LeadTime + SafetyStock`
- **Use case**: T·ª± ƒë·ªông h√≥a quy·∫øt ƒë·ªãnh nh·∫≠p h√†ng
- **Demo**:
  ```sql
  SELECT * FROM fn_CalculateReorderPoint(1, 7, 95.0)
  -- ProductID, LeadTime=7 days, ServiceLevel=95%
  ```

#### 4. `fn_SupplierPerformanceScore` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: ƒê√°nh gi√° hi·ªáu su·∫•t nh√† cung c·∫•p (0-100 ƒëi·ªÉm)
- **K·ªπ thu·∫≠t**: Complex scoring algorithm, STDDEV, LAG
- **Metrics**: Volume + Value + Consistency + Frequency
- **Use case**: Ch·ªçn NCC t·ªët nh·∫•t
- **Demo**:
  ```sql
  SELECT * FROM fn_SupplierPerformanceScore(1, 6) -- SupplierID=1, 6 months
  ```

#### 5. `fn_ProductPriceTrend` ‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: Ph√¢n t√≠ch xu h∆∞·ªõng gi√°
- **K·ªπ thu·∫≠t**: LAG, LEAD, Trend analysis
- **Use case**: D·ª± b√°o gi√°, ph√°t hi·ªán bi·∫øn ƒë·ªông
- **Demo**:
  ```sql
  SELECT * FROM fn_ProductPriceTrend(1, 6) -- ProductID=1, 6 months
  ```

---

### üõ†Ô∏è **STORED PROCEDURES (4) - Automation**

#### 1. `sp_BatchImportReceipts` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: Nh·∫≠p nhi·ªÅu phi·∫øu c√πng l√∫c v·ªõi XML
- **K·ªπ thu·∫≠t**: XML parsing, CURSOR, TRY-CATCH per record
- **Features**:
  - Parse XML th√†nh nhi·ªÅu receipts
  - Error handling ri√™ng cho t·ª´ng phi·∫øu
  - Rollback t·ª´ng phi·∫øu l·ªói, continue v·ªõi phi·∫øu kh√°c
- **Demo**:
  ```sql
  DECLARE @XML XML = N'<Receipts>...</Receipts>';
  EXEC sp_BatchImportReceipts @ReceiptDataXML = @XML, ...
  ```

#### 2. `sp_DynamicPriceStrategy` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: ƒêi·ªÅu ch·ªânh gi√° th√¥ng minh theo 4 strategies
- **K·ªπ thu·∫≠t**: Dynamic SQL, Complex business logic
- **Strategies**:
  1. **ABC-Based**: A: +10%, B: +5%, C: -5%
  2. **Age-Based**: Gi·∫£m gi√° h√†ng t·ªìn l√¢u (>180 days: -20%)
  3. **Manual-Percent**: T√πy ch·ªânh % theo category
  4. **Turnover-Based**: TƒÉng gi√° h√†ng ch·∫°y, gi·∫£m gi√° h√†ng ·∫ø
- **Demo**:
  ```sql
  EXEC sp_DynamicPriceStrategy @Strategy='ABC-Based', @ChangedBy=1
  ```

#### 3. `sp_GenerateReorderSuggestions` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: ƒê·ªÅ xu·∫•t nh·∫≠p h√†ng th√¥ng minh
- **K·ªπ thu·∫≠t**: Complex calculations v·ªõi functions
- **Logic**: Historical consumption + Reorder point + Lead time
- **Output**: ProductID, SuggestedQty, Priority, EstimatedStockoutDays
- **Demo**:
  ```sql
  EXEC sp_GenerateReorderSuggestions @DaysToProject=30, @ServiceLevel=95
  ```

#### 4. `sp_GenerateMonthlyReport` ‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: T·∫°o b√°o c√°o th√°ng (4 lo·∫°i)
- **K·ªπ thu·∫≠t**: Multiple result sets, Dynamic SQL
- **Report types**: Summary, Detailed, ABC, Supplier
- **Demo**:
  ```sql
  EXEC sp_GenerateMonthlyReport @Month=10, @Year=2024, @ReportType='All'
  ```

---

### üîî **TRIGGERS (5) - Automation & Validation**

#### 1. `TR_GoodsReceipts_BusinessRules` ‚≠ê‚≠ê‚≠ê
- **Event**: AFTER INSERT/UPDATE on GoodsReceipts
- **Rules**:
  - ‚ùå Kh√¥ng nh·∫≠p qu√° 5 phi·∫øu/ng√†y t·ª´ 1 supplier
  - ‚ùå T·ªïng gi√° tr·ªã phi·∫øu kh√¥ng qu√° 500 tri·ªáu
  - ‚ùå Kh√¥ng nh·∫≠p h√†ng v√†o Ch·ªß nh·∫≠t
- **K·ªπ thu·∫≠t**: Complex validation v·ªõi subqueries

#### 2. `TR_GoodsReceiptDetails_PriceValidation` ‚≠ê‚≠ê‚≠ê
- **Event**: AFTER INSERT/UPDATE on GoodsReceiptDetails
- **Rules**:
  - ‚ùå Gi√° nh·∫≠p kh√¥ng ch√™nh l·ªách >50% so v·ªõi l·∫ßn tr∆∞·ªõc
  - ‚ùå Quantity kh√¥ng qu√° 10,000 ƒë∆°n v·ªã/d√≤ng
- **K·ªπ thu·∫≠t**: OUTER APPLY, historical comparison

#### 3. `TR_GoodsReceiptDetails_AutoAdjustSellingPrice` ‚≠ê‚≠ê
- **Event**: AFTER INSERT on GoodsReceiptDetails
- **Logic**: Auto tƒÉng gi√° b√°n n·∫øu gi√° nh·∫≠p tƒÉng >20%
- **K·ªπ thu·∫≠t**: Cascading updates

#### 4. `TR_Products_DataQuality` ‚≠ê‚≠ê
- **Event**: AFTER INSERT/UPDATE on Products
- **Validation**:
  - SKU format: Ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ + ch·ª©a s·ªë
  - ProductName: Kh√¥ng ch·ª©a k√Ω t·ª± nguy hi·ªÉm
  - SellingPrice: 0 < Price < 1 t·ª∑
- **K·ªπ thu·∫≠t**: Pattern matching, LIKE

#### 5. `TR_GoodsReceipts_UpdateSupplierMetrics` ‚≠ê
- **Event**: AFTER INSERT/UPDATE on GoodsReceipts
- **M·ª•c ƒë√≠ch**: Track supplier metrics
- **Note**: Dummy trigger (kh√¥ng th√™m b·∫£ng)

---

### üìà **VIEWS (4) - Reporting**

#### 1. `vw_ProductPerformanceDashboard` ‚≠ê‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: Dashboard t·ªïng h·ª£p t·∫•t c·∫£ metrics
- **K·ªπ thu·∫≠t**: Multiple CTEs, Subqueries, Window functions
- **Columns**: 15+ columns bao g·ªìm:
  - Basic info (SKU, Name, Price, Stock)
  - LastImportPrice, ProfitMargin
  - InventoryValue, TotalImports
  - DaysSinceLastImport
  - StockStatus, AgingStatus
  - Categories (STRING_AGG)

#### 2. `vw_SupplierPerformanceSummary` ‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: ƒê√°nh gi√° v√† x·∫øp h·∫°ng NCC
- **K·ªπ thu·∫≠t**: Aggregations, DENSE_RANK, Window functions
- **Metrics**: TotalReceipts, TotalValue, ValueRank, FrequencyRank
- **Rating**: ‚≠ê‚≠ê‚≠ê Xu·∫•t s·∫Øc / ‚≠ê‚≠ê T·ªët / ‚≠ê Trung b√¨nh / M·ªõi

#### 3. `vw_MonthlyImportTrends` ‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: Xu h∆∞·ªõng nh·∫≠p h√†ng theo th√°ng
- **K·ªπ thu·∫≠t**: LAG, Time series, Growth calculation
- **Columns**: YearMonth, TotalValue, PrevMonthValue, GrowthPercent

#### 4. `vw_LowStockAlerts` ‚≠ê‚≠ê
- **M·ª•c ƒë√≠ch**: C·∫£nh b√°o t·ªìn kho th·∫•p
- **K·ªπ thu·∫≠t**: Conditional logic, Subqueries
- **Alert levels**: üî¥ Kh·∫©n c·∫•p / üü† Cao / üü° Trung b√¨nh / üü¢ Th·∫•p

---

## üéì K·ªπ thu·∫≠t DBMS ƒë√£ √°p d·ª•ng

### ‚úÖ **Advanced SQL (15+ techniques)**

| # | K·ªπ thu·∫≠t | √Åp d·ª•ng ·ªü ƒë√¢u | ƒê·ªô ph·ª©c t·∫°p |
|---|----------|---------------|-------------|
| 1 | **Window Functions** | 5 functions, 3 views | ‚≠ê‚≠ê‚≠ê |
| 2 | **Statistical Functions** | fn_CalculateReorderPoint, fn_SupplierScore | ‚≠ê‚≠ê‚≠ê |
| 3 | **XML Parsing** | sp_BatchImportReceipts | ‚≠ê‚≠ê‚≠ê |
| 4 | **CURSOR** | sp_BatchImportReceipts | ‚≠ê‚≠ê‚≠ê |
| 5 | **Dynamic SQL** | sp_DynamicPriceStrategy | ‚≠ê‚≠ê‚≠ê |
| 6 | **CTEs** | T·∫•t c·∫£ functions, views | ‚≠ê‚≠ê |
| 7 | **LAG/LEAD** | fn_ProductPriceTrend, vw_MonthlyTrends | ‚≠ê‚≠ê‚≠ê |
| 8 | **PERCENT_RANK** | fn_ProductABCClassification | ‚≠ê‚≠ê |
| 9 | **STDEV** | fn_CalculateReorderPoint, fn_SupplierScore | ‚≠ê‚≠ê‚≠ê |
| 10 | **DENSE_RANK** | vw_SupplierPerformanceSummary | ‚≠ê‚≠ê |
| 11 | **ROWS BETWEEN** | Window frames | ‚≠ê‚≠ê‚≠ê |
| 12 | **OUTER APPLY** | Triggers, Views | ‚≠ê‚≠ê |
| 13 | **STRING_AGG** | Views | ‚≠ê‚≠ê |
| 14 | **Multiple Result Sets** | sp_GenerateMonthlyReport | ‚≠ê‚≠ê |
| 15 | **Complex Validation** | 5 triggers | ‚≠ê‚≠ê‚≠ê |

---

## üìÅ Files ƒë√£ t·∫°o

```
code_sql_server/
‚îú‚îÄ‚îÄ advanced_functions.sql                  (5 Functions - 350 d√≤ng)
‚îú‚îÄ‚îÄ advanced_stored_procedures.sql          (4 SPs - 400 d√≤ng)
‚îú‚îÄ‚îÄ advanced_triggers_views.sql             (5 Triggers + 4 Views - 450 d√≤ng)
‚îú‚îÄ‚îÄ advanced_features_test.sql              (Test & Demo - 500 d√≤ng)
‚îú‚îÄ‚îÄ run_all_advanced_features.sql           (Master file - 100 d√≤ng)
‚îú‚îÄ‚îÄ ADVANCED_FEATURES_README.md             (Documentation - chi ti·∫øt)
‚îî‚îÄ‚îÄ ADVANCED_FEATURES_SUMMARY.md            (File n√†y - T√≥m t·∫Øt)

T·ªîNG: ~1800 d√≤ng SQL code m·ªõi
```

---

## üöÄ C√°ch s·ª≠ d·ª•ng

### **B∆∞·ªõc 1: C√†i ƒë·∫∑t**

```sql
-- Option A: Ch·∫°y t·∫•t c·∫£ c√πng l√∫c (Khuy·∫øn ngh·ªã)
USE QLNhapHang;
:r run_all_advanced_features.sql

-- Option B: Ch·∫°y t·ª´ng file
:r advanced_functions.sql
:r advanced_stored_procedures.sql
:r advanced_triggers_views.sql
```

### **B∆∞·ªõc 2: Test**

```sql
-- Ch·∫°y t·∫•t c·∫£ test cases
:r advanced_features_test.sql
```

### **B∆∞·ªõc 3: S·ª≠ d·ª•ng trong ·ª©ng d·ª•ng C#**

Th√™m v√†o `QLNhapHangDataSet.xsd`:
- 5 Functions
- 4 Stored Procedures
- 4 Views

T·∫°o TableAdapters t∆∞∆°ng ·ª©ng.

---

## üíØ ƒê√°nh gi√° cho B√†i Cu·ªëi k√¨

### **Ti√™u ch√≠ ƒë·∫°t ƒë∆∞·ª£c:**

| Ti√™u ch√≠ | Y√™u c·∫ßu | ƒê·∫°t | Ghi ch√∫ |
|----------|---------|-----|---------|
| **Functions ph·ª©c t·∫°p** | ‚â•3 | ‚úÖ **5** | Window, Statistical |
| **SPs v·ªõi XML/Cursor** | ‚â•1 | ‚úÖ **2** | Batch Import, Dynamic Price |
| **Triggers n√¢ng cao** | ‚â•2 | ‚úÖ **5** | Business rules, Validation |
| **Views ph·ª©c t·∫°p** | ‚â•2 | ‚úÖ **4** | CTEs, Aggregations |
| **Transaction handling** | C√≥ | ‚úÖ | TRY-CATCH, Rollback |
| **Kh√¥ng ƒë·ªïi schema** | B·∫Øt bu·ªôc | ‚úÖ | 100% tu√¢n th·ªß |
| **Documentation** | ƒê·∫ßy ƒë·ªß | ‚úÖ | README + Test + Comments |

### **ƒêi·ªÉm n·ªïi b·∫≠t:**

1. ‚≠ê‚≠ê‚≠ê **ABC Analysis** - √Åp d·ª•ng Pareto th·ª±c t·∫ø
2. ‚≠ê‚≠ê‚≠ê **Reorder Point Calculator** - Statistical functions
3. ‚≠ê‚≠ê‚≠ê **Batch Import XML** - CURSOR + Error handling
4. ‚≠ê‚≠ê‚≠ê **Dynamic Price Strategy** - 4 strategies th√¥ng minh
5. ‚≠ê‚≠ê‚≠ê **Supplier Performance** - Scoring algorithm

---

## üìä So s√°nh v·ªõi Requirements

### **Y√™u c·∫ßu c·ªßa th·∫ßy:**

> "fn c√≤n qu√° ƒë∆°n gi·∫£n, sp, trigger c≈©ng ch∆∞a ƒëa d·∫°ng l·∫Øm, v·ªõi r√†ng bu·ªôc ko ƒë∆∞·ª£c thay ƒë·ªïi schema n·ªØa"

### **ƒê√£ gi·∫£i quy·∫øt:**

‚úÖ **Functions**: T·ª´ ƒë∆°n gi·∫£n ‚Üí Ph·ª©c t·∫°p v·ªõi Window Functions, Statistics  
‚úÖ **SPs**: Th√™m XML, Cursor, Dynamic SQL  
‚úÖ **Triggers**: Th√™m Business Rules, Complex Validation  
‚úÖ **Schema**: KH√îNG thay ƒë·ªïi (100% tu√¢n th·ªß)  
‚úÖ **Documentation**: ƒê·∫ßy ƒë·ªß h∆∞·ªõng d·∫´n + test cases  

---

## üéâ K·∫øt lu·∫≠n

### **Tr∆∞·ªõc khi th√™m:**
- Functions: ƒê∆°n gi·∫£n (SELECT c∆° b·∫£n)
- SPs: Ch·ªâ CRUD
- Triggers: Ch·ªâ auto-update c∆° b·∫£n

### **Sau khi th√™m:**
- Functions: **Ph√¢n t√≠ch Pareto, Statistical calculations, Trend analysis**
- SPs: **XML parsing, Cursor, Dynamic SQL, Smart algorithms**
- Triggers: **Business rules validation, Cascading updates**
- Views: **Dashboard v·ªõi CTEs, Window functions**

### **ƒê·ªß ƒëi·ªÅu ki·ªán:**
‚úÖ B√†i cu·ªëi k√¨ DBMS ƒëi·ªÉm cao  
‚úÖ Th·ªÉ hi·ªán ki·∫øn th·ª©c n√¢ng cao  
‚úÖ √Åp d·ª•ng th·ª±c t·∫ø  
‚úÖ Code s·∫°ch, c√≥ documentation  

---

**üéì CH√öC B·∫†N ƒê·∫†T ƒêI·ªÇM CAO TRONG B√ÄI CU·ªêI K√å DBMS! üéì**
